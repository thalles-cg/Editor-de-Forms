<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="./components/gallery/gallery.css">
  <link rel="stylesheet" href="./components/header/header.css">
  <link rel="stylesheet" href="./components/menu/menu.css">
  <link rel="stylesheet" href="preview.css">
  <title>Prévia do Formulário</title>
</head>
<body>
  <button class="btn" onclick="downloadFullHTML()">Baixar HTML Completo</button>
  <main>
    <div class="not-footer">
      <div class="header-menu">
        <div id="header-container"></div>
        <div id="menu-container"></div>
      </div>
      <div id="forms-container"></div>
      <div id="gallery-container"></div>
    </div>
    <div id="footer-container"></div>
  </main>

  <script>
    // Carrega os dados do localStorage
    const headerSalvo = localStorage.getItem('headerSelecionado');
    const menuSalvo = localStorage.getItem('menuSelecionado');
    const gallerySalvo = localStorage.getItem('gallerySelecionado');
    const formsSalvo = localStorage.getItem('formsSelecionado');
    const footerSalvo = localStorage.getItem('footerSelecionado');

    // Exibe na prévia
    document.getElementById('header-container').innerHTML = headerSalvo || '<p>Nada exportado.</p>';
    document.getElementById('menu-container').innerHTML = menuSalvo || '<p>Nada exportado.</p>';
    document.getElementById('gallery-container').innerHTML = gallerySalvo || '<p>Nada exportado.</p>';
    document.getElementById('forms-container').innerHTML = formsSalvo || '<p>Nada exportado.</p>';
    document.getElementById('footer-container').innerHTML = footerSalvo || '<p>Nada exportado.</p>';

    async function fetchCSS(url) {
      try {
        const response = await fetch(url);
        return await response.text();
      } catch (e) {
        console.error(`Erro ao carregar CSS: ${url}`, e);
        return '';
      }
    }

    async function downloadFullHTML() {
      // Coletar todos os estilos CSS
      const cssFiles = [
        'style.css',
        './components/gallery/gallery.css',
        './components/header/header.css',
        './components/menu/menu.css',
        'preview.css'
      ];
      
      let combinedCSS = '';
      for (const file of cssFiles) {
        combinedCSS += await fetchCSS(file) + '\n';
      }
      
      // Criar cópia do DOM para exportação
      const exportClone = document.cloneNode(true);
      const exportBody = exportClone.body;
      
      // Remover o botão de download
      const btn = exportBody.querySelector('.btn');
      if (btn) btn.remove();
      
      // Atualizar containers com conteúdo do localStorage
      const containers = {
        'header-container': localStorage.getItem('headerSelecionado'),
        'menu-container': localStorage.getItem('menuSelecionado'),
        'gallery-container': localStorage.getItem('gallerySelecionado'),
        'forms-container': localStorage.getItem('formsSelecionado'),
        'footer-container': localStorage.getItem('footerSelecionado')
      };

      for (const [id, content] of Object.entries(containers)) {
        const element = exportBody.querySelector(`#${id}`);
        if (element && content) {
          element.innerHTML = content;
        }
      }

      // Gerar o HTML final
      const fullHTML = `<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Página Exportada</title>
  <style>${combinedCSS}</style>
</head>
${exportBody.innerHTML}
</html>`;
      
      // Criar e disparar o download
      const blob = new Blob([fullHTML], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'pagina-exportada.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>